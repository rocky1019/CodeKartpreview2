<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sell on CodeKart</title>
<link rel="icon" type="image/png" href="assets/images/codekart-removebg-preview.png"/>
<style>
  :root{--primary:#FF6B6B;--secondary:#4ECDC4;--bg:#f4f4f4;--card:#fff;--text:#111;}
  *{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif}
  body{background:var(--bg);color:var(--text)}
  header.navbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:var(--card);box-shadow:0 2px 5px rgba(0,0,0,.1);position:sticky;top:0;z-index:10}
  #logo{display:flex;align-items:center;gap:8px;font-size:1.5rem;font-weight:700;color:var(--primary)}
  #logo img{height:40px;width:auto}
  nav ul{display:flex;gap:2rem;list-style:none}
  nav a{text-decoration:none;color:var(--text)}
  nav a:hover{color:var(--primary)}

  .wrap{max-width:900px;margin:2rem auto;padding:0 1rem}
  .title{font-size:2rem;font-weight:700;text-align:center;margin-bottom:1.5rem;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .card{background:var(--card);border:none;border-radius:20px;padding:2rem;box-shadow:0 10px 25px rgba(0,0,0,.08)}
  form{display:grid;gap:1.2rem}
  .row{display:grid;gap:.5rem}
  label{font-size:.95rem;font-weight:600;color:#333}

  input[type="text"],input[type="url"],textarea{
    padding:.9rem 1rem;border:1px solid #e5e7eb;border-radius:12px;outline:none;background:#fff;transition:border .2s,box-shadow .2s}
  input:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(255,107,107,.2)}
  textarea{min-height:140px;resize:vertical}

  .filebox{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
  .hint{font-size:.82rem;color:#666}

  .actions{display:flex;gap:.8rem;justify-content:flex-end;margin-top:1rem}
  .btn{padding:.9rem 1.2rem;border-radius:12px;border:1px solid #e5e7eb;background:var(--card);cursor:pointer;font-weight:600;transition:all .2s}
  .btn:hover{transform:translateY(-2px)}
  .btn-primary{background:var(--primary);color:#fff;border:none}
  .btn-primary:hover{filter:brightness(.95)}
  .btn-secondary{background:var(--secondary);color:#fff;border:none}
  .btn-secondary:hover{filter:brightness(.95)}

  progress{width:100%;height:12px;appearance:none;border-radius:999px;overflow:hidden}
  progress::-webkit-progress-bar{background:#f1f5f9}
  progress::-webkit-progress-value{background:linear-gradient(90deg,var(--secondary),var(--primary))}
  .status{min-height:1.2rem;font-size:.95rem;margin-top:.3rem}
  .ok{color:#1b8a5a}.err{color:#d64545}

  .thumb-preview{width:100%;max-width:520px;border-radius:12px;border:1px solid #eee;box-shadow:0 6px 16px rgba(0,0,0,.06)}
</style>
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div id="logo">
      <img src="assets/images/codekart-removebg-preview.png" alt="CodeKart Logo"><span>CodeKart</span>
    </div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="prouduct.html">Explore</a></li>
        <li><a class="active" href="sell.html">Sell</a></li>
        <li><a href="profile.html">Profile</a></li>
      </ul>
    </nav>
  </header>

  <main class="wrap">
    <h1 class="title">List a New Product</h1>
    <section class="card">
      <form id="sellForm">
        <div class="row">
          <label for="name">Project name *</label>
          <input id="name" type="text" placeholder="e.g., Modern Portfolio Template" required />
        </div>

        <div class="row">
          <label for="desc">Description *</label>
          <textarea id="desc" placeholder="Describe features, tech stack, and what buyers get." required></textarea>
        </div>

        <!-- THUMBNAIL upload to Supabase -->
        <div class="row">
          <label>Display picture / Thumbnail *</label>
          <div class="filebox">
            <input id="thumbFile" type="file" accept="image/*" />
            <button id="thumbUploadBtn" type="button" class="btn btn-secondary">Upload image</button>
            <span class="hint">PNG/JPG/WebP · ~1200×750 · ≤ 5MB</span>
          </div>
          <input id="thumbUrl" type="url" placeholder="https://.../thumbnail.jpg" required />
          <img id="thumbPreview" class="thumb-preview" alt="" style="display:none;margin-top:.5rem"/>
        </div>

        <!-- ZIP upload to Supabase -->
        <div class="row">
          <label>Project file (ZIP) *</label>
          <div class="filebox">
            <input id="fileZip" type="file" accept=".zip" />
            <button id="fileUploadBtn" type="button" class="btn btn-secondary">Upload ZIP</button>
            <span class="hint">.zip only · ≤ 50MB (tune later)</span>
          </div>
          <input id="fileUrl" type="url" placeholder="https://.../project.zip" required readonly />
        </div>
<div class="row">
  <label for="price">Price (₹)</label>
  <input id="price" type="number" min="0" placeholder="e.g. 499" />
</div>

<div class="row">
  <label for="category">Category</label>
  <select id="category">
    <option value="">Select category</option>
    <option value="web">Web Template</option>
    <option value="mobile">Mobile Template</option>
    <option value="design">Design Asset</option>
    <option value="script">Script/Code</option>
  </select>
</div>

<div class="row">
  <label for="tags">Tags (comma separated)</label>
  <input id="tags" type="text" placeholder="e.g. react, ui, dashboard" />
</div>

        <div class="row">
          <label for="demo">Demo URL (optional)</label>
          <input id="demo" type="url" placeholder="https://your-demo-url.com" />
        </div>

        <!-- Progress bars -->
        <div class="row">
          <label>Upload progress</label>
          <progress id="pThumb" max="100" value="0"></progress>
          <progress id="pFile"  max="100" value="0"></progress>
          <div id="status" class="status"></div>
        </div>

        <div class="actions">
          <a class="btn" href="dashboard.html">Cancel</a>
          <button id="submitBtn" class="btn btn-primary" type="submit">Publish</button>
        </div>
      </form>
    </section>
  </main>

  <!-- Firebase (Auth + Firestore) + Supabase (Storage) -->
  <script type="module">
  /* ---------- Firebase ---------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDIt727HxMoAk8jMwhLH2-zcLXGmBdj_Ys",
    authDomain: "codekart-5652e.firebaseapp.com",
    projectId: "codekart-5652e",
    storageBucket: "codekart-5652e.firebasestorage.app",
    messagingSenderId: "430655059434",
    appId: "1:430655059434:web:290df76af0c7bf8c882e93",
    measurementId: "G-WHPZ6BWZ4Q"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ---------- Supabase (Storage) ---------- */
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const SUPABASE_URL  = "https://ixgiafhbfjpbqclwefgf.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4Z2lhZmhiZmpwYnFjbHdlZmdmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwNjYxMDUsImV4cCI6MjA3MTY0MjEwNX0.qmlHYOcbWSkYMNNw_s8ymTGIt1e4xLAK-cXXAmALyuE";
  const BUCKET = "codekart";
  const supa = createClient(SUPABASE_URL, SUPABASE_ANON);

  // Elements
  const form = document.getElementById('sellForm');
  const nameEl = document.getElementById('name');
  const descEl = document.getElementById('desc');
  const thumbFileEl = document.getElementById('thumbFile');
  const thumbBtn = document.getElementById('thumbUploadBtn');
  const thumbUrlEl = document.getElementById('thumbUrl');
  const thumbPreview = document.getElementById('thumbPreview');
  const fileZipEl = document.getElementById('fileZip');
  const fileBtn = document.getElementById('fileUploadBtn');
  const fileUrlEl = document.getElementById('fileUrl');
  const demoEl = document.getElementById('demo');
  const pThumb = document.getElementById('pThumb');
  const pFile = document.getElementById('pFile');
  const statusEl = document.getElementById('status');
  const submitBtn = document.getElementById('submitBtn');
  const priceEl = document.getElementById('price');
const categoryEl = document.getElementById('category');
const tagsEl = document.getElementById('tags');


  const ok  = (m)=>{ statusEl.className = "status ok";  statusEl.textContent = m; };
  const err = (m)=>{ statusEl.className = "status err"; statusEl.textContent = m; };

  let currentUser = null;
  // Disable form until we know auth state
  submitBtn.disabled = true;

  onAuthStateChanged(auth, (user) => {
    currentUser = user || null;
    console.log("auth uid =", currentUser?.uid);
    if (!currentUser) {
      // not signed in → bounce to login
      window.location.href = "login.html";
      return;
    }
    submitBtn.disabled = false; // allow submit now
  });

  // small util for smooth progress
  function smoothProgress(el, target){
    const t = Math.max(0, Math.min(100, target));
    if (t <= el.value) return;
    const step = () => {
      el.value += Math.max(1, Math.round((t - el.value) / 5));
      if (el.value < t) requestAnimationFrame(step);
    };
    requestAnimationFrame(step);
  }

  /* ---- Thumbnail upload to Supabase ---- */
  thumbBtn.addEventListener('click', () => thumbFileEl.click());
  thumbFileEl.addEventListener('change', async () => {
    const f = thumbFileEl.files?.[0];
    if (!f) return;
    if (!/^image\//.test(f.type)) return err("Please select an image (png/jpg/webp).");
    if (f.size > 5 * 1024 * 1024) return err("Image too large. Max 5 MB.");
    const fr = new FileReader();
    fr.onload = () => { thumbPreview.src = fr.result; thumbPreview.style.display = 'block'; };
    fr.readAsDataURL(f);

    pThumb.value = 0; ok("Uploading image…"); smoothProgress(pThumb, 35);

    try {
      const uid = currentUser?.uid || "anon";
      const safe = f.name.replace(/[^\w.\-]/g, "_");
      const path = `thumbs/${uid}/${Date.now()}_${safe}`;
      const { error } = await supa.storage.from(BUCKET).upload(path, f, { cacheControl: '3600', upsert:false, contentType:f.type });
      if (error) { console.error(error); return err("Image upload failed."); }
      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      if (!pub?.publicUrl) return err("Could not get image URL.");
      thumbUrlEl.value = pub.publicUrl;
      smoothProgress(pThumb, 100);
      ok("Image uploaded ✔");
      console.log("thumbUrl ->", pub.publicUrl);
    } catch (e) { console.error(e); err("Image upload failed."); }
  });

  /* ---- ZIP upload to Supabase ---- */
  fileBtn.addEventListener('click', () => fileZipEl.click());
  fileZipEl.addEventListener('change', async () => {
    const f = fileZipEl.files?.[0];
    if (!f) return;
    if (!f.name.toLowerCase().endsWith(".zip")) return err("Only .zip files allowed.");
    if (f.size > 50 * 1024 * 1024) return err("File too large. Max 50 MB.");

    pFile.value = 0; ok("Uploading project…"); smoothProgress(pFile, 40);

    try {
      const uid = currentUser?.uid || "anon";
      const safe = f.name.replace(/[^\w.\-]/g, "_");
      const path = `zips/${uid}/${Date.now()}_${safe}`;
      const { error } = await supa.storage.from(BUCKET).upload(path, f, { cacheControl:'3600', upsert:false, contentType: f.type || 'application/zip' });
      if (error) { console.error(error); return err("ZIP upload failed."); }
      const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
      if (!pub?.publicUrl) return err("Could not get ZIP URL.");
      fileUrlEl.value = pub.publicUrl;
      smoothProgress(pFile, 100);
      ok("ZIP uploaded ✔");
      console.log("fileUrl  ->", pub.publicUrl);
    } catch (e) { console.error(e); err("ZIP upload failed."); }
  });

  /* ---- Publish to Firestore ---- */
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return err("Please login to publish.");

    const name = nameEl.value.trim();
    const desc = descEl.value.trim();
    const thumbUrl = thumbUrlEl.value.trim();
    const fileUrl  = fileUrlEl.value.trim();
    const demoUrl  = (demoEl.value.trim() || null);

    if (!name || !desc) return err("Please fill name and description.");
    if (!thumbUrl) return err("Please upload a thumbnail first.");
    if (!fileUrl)  return err("Please upload the ZIP first.");
    if (!/\.zip(\?|$)/i.test(fileUrl)) return err("ZIP URL must point to a .zip file.");

 const payload = {
  name,
  description: desc,
  price: priceEl.value.trim() === "" ? null : Number(priceEl.value),
  category: categoryEl.value.trim() || null,
  tags: tagsEl.value.trim() === "" ? [] : tagsEl.value.split(",").map(t => t.trim()).filter(Boolean),
  thumbUrl,
  fileUrl,
  demoUrl,
  sellerId: currentUser.uid,
  createdAt: serverTimestamp(),
  status: "active"
};

    console.log("creating product ->", { ...payload, createdAt: "(serverTimestamp)" });

    submitBtn.disabled = true; ok("Publishing…");
    try {
      await addDoc(collection(db, "products"), payload);
      ok("Published! Redirecting…");
      setTimeout(()=> window.location.href = "prouduct.html", 700);
    } catch (e) {
      console.error("addDoc failed", e);
      err("Publish failed: " + (e?.message || "permission denied"));
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>

</body>
</html>
